<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CMRS Map 1</title>

<style type="text/css">

body {
    margin: 0;
    background: #002400;
    color: #FFF;
}

.svg {
    margin: auto;
    width: 100%;
    height: 100%;
}

.load {
    position: absolute;
    top: 50%;
    left: 40%;
    font-size: xx-large;
}

</style>

</head>

<body>
<div id="svg_container" class="svg"></div>
<div id="loader" class="load">Please wait, loading...</div>
</body>


<!-- Source for local copy of svg-2.6.3.min.js comes from: -->
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.min.js"></script-->
<!--script src="https://cdnjs.cloudflare.com/ajax/libs/svg.js/2.6.3/svg.js"></script-->


<script src="http://localhost:12080/js/jquery-1.11.2.min.js"></script>
<script src="http://localhost:12080/js/json2.js"></script>
<script src="http://localhost:12080/js/jquery.websocket.js"></script>
<script src="http://localhost:12080/js/jquery.jmri.js"></script>

<script src="http://localhost:12080/dist/web/cmrs/svg-2.6.3.min.js"></script>
<script>

var svgUrl  = "http://localhost:12080/dist/web/cmrs/map1.svg";
var jmriUrl = "http://localhost:12080/json/";
var svgDoc;
var jmri;

function setupJmri() {
    jmri = $.JMRI(jmriUrl, {
        open : function() { console.log("JMRI: open "); },
        close: function() { console.log("JMRI: close"); },

        hello : function() {
            console.log("JMRI: hello");

            svgDoc.select('[id^="N"]').each(function () {
                setupTurnout(this);
            });
        },

        turnout: function (name, state, data) {
            console.log("Got turnout \"" + name + "\" with state " + state + ".");

            var idNormal = name.substring(1);
            var idThrown = "R" + idNormal.substring(1);
            var isClosed = state === jmri.CLOSED;

            $("#" + idNormal).fadeTo(250, isClosed ? 1 : 0);
            $("#" + idThrown).fadeTo(250, isClosed ? 0 : 1);

            //svgDoc.select("#" + idNormal).each(function() { this.style("opacity", isClosed ? "1" : "0"); });
            //svgDoc.select("#" + idThrown).each(function() { this.style("opacity", isClosed ? "0" : "1"); })
        },
        console: function(data) { console.log("JMRI: " + data); },
        goodbye : function() { console.log("JMRI: goodbye "); },
        didReconnect : function() { console.log("JMRI: didReconnect "); },
        failedReconnect  : function() { console.log("JMRI: failedReconnect  "); }
    })
    jmri.connect();
}

function loadSvg() {
    console.log( "document loaded" );
    $("#svg_container").hide();
    svgDoc = SVG("svg_container");
    $.get(svgUrl, function(contents) {
        var _tmp = $("svg", contents);
        
        svgDoc.attr('viewBox',  _tmp.attr('viewBox'));
        svgDoc.attr('width',    _tmp.attr('width'));
        svgDoc.attr('height',   _tmp.attr('height'));

        svgDoc.svg(_tmp.html());
        
        console.log( "SVG loaded" );

        $("#svg_container").fadeIn();
        $("#loader").fadeOut();

        setupJmri();
    }, "xml");
}

function setupTurnout(t) {
    var tid = t.attr("id").substring(1);
    var jmriName = "NT" + tid;

    console.log("Setup turnout: " + jmriName);

    jmri.getTurnout(jmriName);

/*    console.log(tid) ;
    t.style("visibility", "visible");
    t.style("opacity", "0");
    t._op = 0;
    t.click(function() {
        console.log( tid + " " + t._op );
        t.animate(125, "<>", 0).style("opacity", "1").animate(125, "<>", 0).style("opacity", "0");
        t._op = 1 - t._op;
        jmri.setTurnout(jmriName, (t._op == 0) ? jmri.CLOSED : jmri.THROWN);
    });
    */
}


$( document ).ready(loadSvg);
</script>

</html>
